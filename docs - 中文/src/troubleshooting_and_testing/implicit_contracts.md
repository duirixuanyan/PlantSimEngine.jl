本页面总结了在使用PlantSimEngine实现新模型时，可能需要特别注意的一些假设、耦合约束和内部工作机制。

如果你对具体实现的细节存在疑问，可以查阅本页面，看看是否能为你解答。

```@contents
Pages = ["implicit_contracts.md"]
Depth = 2
```

## 天气数据提供仿真的时间步长，但模型可以偏离它

天气数据的时间步长，无论是按小时还是按天，通常决定了大多数其他模型的运行节奏。

在 XPalm 中，大多数模型的天气数据按天提供，这意味着生物量的计算也是按天进行的。

许多模型在该时间范围内被认为是稳态的，但也并非全部：例如，叶片修剪模型对植株的影响是非稳态的。此外，一些需要多次迭代计算以实现稳定（通常属于强依赖部分）的模型，其时间步长也可能与天气数据无关。

!!! 注意
    这意味着，传递给仿真的任意向量变量必须与天气时间步数保持一致。唯一的例外是：如果只提供一个天气值但提供了更长的向量变量，系统会在每一个时间步重复使用该天气值。（未来如果支持单个仿真中不同的时间步长，该功能可能会变化）

## 仿真前必须对天气数据进行插值处理

如果你的天气数据没有调整为符合规律的时间步长（例如每日、每小时等），则需要你自行进行调整。PlantSimEngine 在仿真前不会自动进行插值处理，期望输入的数据已经是规律的时间步长。

## 简化的依赖图不能有循环依赖

用于仿真的模型依赖图由软依赖节点和硬依赖节点组成，最终只保留软依赖节点之间的连接，并且应当确保没有循环依赖。

任何用户模型的耦合如果导致出现循环依赖，则需要做额外处理：要么重新设计模型，要么对部分有问题的模型建立强依赖关系，或者通过让某个变量采用上一个时间步的值来打破循环。

关于依赖图约束的更多讨论，请见[依赖图（Dependency graphs）](@ref)及以下小节。

注意：在PlantSimEngine中，除非专门设计模型，目前只能访问前一个时间步的状态。如果需要存储更多过往时间步信息，可参考[提示与变通方法](@ref)页面中的[多尺度模拟中利用历史状态的方法](@ref)内容。

## 硬依赖必须在模型定义中声明

硬依赖由其所属的软依赖模型在内部处理，即硬依赖的 `run!` 函数会被软依赖的 `run!` 函数直接调用。

目前 PlantSimEngine 构建依赖图的方式要求用户在硬依赖中明确声明所需的过程，以及该依赖需要从哪个尺度调取模型及其变量。

## 并行化的机会必须在模型定义中体现

指示模型是否独立或者是否可以并行的特性，必须在模型定义时加以说明。建模者在实现新模型时需要注意这一点。

目前，这主要是单一尺度仿真时的关注点，因为多尺度仿真还未实现并行化；当模型修改 MTG 时，需要实现更复杂的调度器，并在特定尺度支持更有价值的并行化机会。

未来，针对多植株仿真，可能会有新的并行化功能推出。

## 硬依赖在依赖图中只能有一个父节点

最终的依赖关系图仅包含软依赖节点，并且被保证不存在循环。硬依赖由其所属的软依赖祖先在内部处理。为了避免处理顺序上的歧义，每个硬依赖只能由一个软依赖节点“拥有”，同理，嵌套的硬依赖也只能有一个软依赖祖先。

这不仅是 PlantSimEngine 内部实现的细节，如果你的仿真需要复杂的耦合，可能需要慎重考虑如何管理硬依赖，或者插入额外的中间模型来简化结构。

## 一个模型在同一尺度下只能使用一次

同样地，为了避免依赖图中的歧义（并保证仿真的一致性），PlantSimEngine 目前假设对同一过程的建模，每个模型在同一尺度下只出现一次。

通过重命名模型或复制模型可以绕过该限制。未来随着多植株/多物种功能的实现，这一假设可能会有所变化。

## 同一尺度下不能有同名变量

此规则旨在避免潜在的歧义，否则在仿真过程中不仅会影响模型的执行顺序，还可能导致模型错误地耦合到不正确的变量。

对于某些需要同时作为输入和输出变量的情况，可以参考这里的变通方法：[模型中变量不能同时作为输入和输出](@ref)。

## 新增模型时的仿真顺序不稳定

需要特别注意的是，PlantSimEngine 会自动根据模型之间的依赖关系图确定模型的执行顺序。

仿真的执行顺序依赖于模型之间的耦合方式。如果你用一组新模型替换了原有模型，或者加入了创建新耦合关系的新变量，都可能导致仿真顺序发生变化。

在不断迭代并逐步增强仿真的生理机制复杂性时，很容易因为用户的更改而导致两个模型的执行顺序被颠倒。

这一设计选择是为了方便和灵活地开发仿真模型作出的权衡——意味着在你的模型组合尚未完全稳定，并且还不清楚哪些变量是 `PreviousTimestep` 以及模型具体执行顺序时，随着你不断扩展和调整模型集合，有些模型在单步仿真中的执行效果可能会有差异。这本身不是一个概念性的问题，因为大多数模型都是稳态的，而且对于固定的模型集合，仿真顺序是稳定的。但这也意味着 PlantSimEngine 在某些类型的仿真应用中会有不够便利的地方。